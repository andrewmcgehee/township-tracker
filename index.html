<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Township Card Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // ============================================
        // CUSTOMIZE YOUR CARDS HERE
        // ============================================
        const CARD_DATA = {
            'Adventure': [
                'Compass', 'Backpack', 'Map', 'Tent', 'Canteen', 
                'Binoculars', 'Rope', 'Flashlight', 'Knife', 'Boots',
                'Hat', 'Camera', 'Journal', 'Whistle', 'First Aid'
            ],
            'Animals': [
                'Dog', 'Cat', 'Horse', 'Cow', 'Chicken',
                'Pig', 'Sheep', 'Rabbit', 'Duck', 'Goat',
                'Turkey', 'Donkey', 'Llama', 'Peacock', 'Hedgehog'
            ],
            'Beach': [
                'Surfboard', 'Umbrella', 'Sandcastle', 'Beach Ball', 'Flip Flops',
                'Sunglasses', 'Ice Cream', 'Bucket', 'Shovel', 'Starfish',
                'Shell', 'Crab', 'Lifeguard', 'Coconut', 'Kite'
            ],
            'Circus': [
                'Clown', 'Elephant', 'Lion', 'Trapeze', 'Juggler',
                'Tent', 'Ringmaster', 'Tightrope', 'Fire Eater', 'Acrobat',
                'Seal', 'Cannon', 'Unicycle', 'Magic Hat', 'Cotton Candy'
            ],
            'Fairytale': [
                'Castle', 'Dragon', 'Princess', 'Knight', 'Crown',
                'Wand', 'Unicorn', 'Fairy', 'Wizard', 'Potion',
                'Sword', 'Magic Book', 'Crystal Ball', 'Phoenix', 'Throne'
            ],
            'Festivals': [
                'Fireworks', 'Balloon', 'Confetti', 'Party Hat', 'Cake',
                'Gift', 'Streamers', 'Candle', 'Banner', 'Mask',
                'Music Note', 'Drum', 'Trumpet', 'Dance', 'Costume'
            ],
            'Landmarks': [
                'Statue of Liberty', 'Eiffel Tower', 'Big Ben', 'Colosseum', 'Taj Mahal',
                'Great Wall', 'Pyramids', 'Opera House', 'Golden Gate', 'Leaning Tower',
                'Sphinx', 'Christ Redeemer', 'Stonehenge', 'Machu Picchu', 'Acropolis'
            ],
            'Nature': [
                'Tree', 'Flower', 'Mountain', 'River', 'Sun',
                'Moon', 'Star', 'Cloud', 'Rainbow', 'Waterfall',
                'Forest', 'Lake', 'Butterfly', 'Bird', 'Leaf'
            ],
            'Science': [
                'Microscope', 'Telescope', 'Beaker', 'Atom', 'DNA',
                'Robot', 'Rocket', 'Planet', 'Lab Coat', 'Test Tube',
                'Magnet', 'Battery', 'Light Bulb', 'Gear', 'Calculator'
            ],
            'Sports': [
                'Football', 'Basketball', 'Baseball', 'Tennis', 'Soccer',
                'Golf', 'Hockey', 'Volleyball', 'Rugby', 'Cricket',
                'Bowling', 'Badminton', 'Boxing Gloves', 'Trophy', 'Medal'
            ]
        };
        // ============================================

        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [users, setUsers] = useState({});
            const [showLogin, setShowLogin] = useState(true);
            const [activeTab, setActiveTab] = useState('my-cards');
            const [searchFriend, setSearchFriend] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('all');

            const CATEGORIES = Object.keys(CARD_DATA);
            const TOTAL_CARDS = Object.values(CARD_DATA).reduce((sum, cards) => sum + cards.length, 0);

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                try {
                    const result = await window.storage.get('township-users');
                    if (result) {
                        setUsers(JSON.parse(result.value));
                    }
                } catch (error) {
                    console.log('No existing data, starting fresh');
                }
            };

            const saveData = async (newUsers) => {
                try {
                    await window.storage.set('township-users', JSON.stringify(newUsers));
                    setUsers(newUsers);
                } catch (error) {
                    console.error('Failed to save data:', error);
                }
            };

            const generateUserId = () => {
                return 'TS' + Math.random().toString(36).substr(2, 8).toUpperCase();
            };

            const createUser = (username) => {
                const userId = generateUserId();
                const newUser = {
                    id: userId,
                    username,
                    cards: Array(TOTAL_CARDS).fill(0),
                    friends: []
                };
                const newUsers = { ...users, [userId]: newUser };
                saveData(newUsers);
                setCurrentUser(userId);
                setShowLogin(false);
            };

            const loginUser = (userId) => {
                if (users[userId]) {
                    setCurrentUser(userId);
                    setShowLogin(false);
                } else {
                    alert('User ID not found!');
                }
            };

            const updateCard = (cardIndex, value) => {
                const updatedUsers = { ...users };
                updatedUsers[currentUser].cards[cardIndex] = Math.max(0, value);
                saveData(updatedUsers);
            };

            const addFriend = (friendId) => {
                if (!users[friendId]) {
                    alert('Friend ID not found!');
                    return;
                }
                if (friendId === currentUser) {
                    alert('You cannot add yourself as a friend!');
                    return;
                }
                const updatedUsers = { ...users };
                if (!updatedUsers[currentUser].friends.includes(friendId)) {
                    updatedUsers[currentUser].friends.push(friendId);
                    saveData(updatedUsers);
                    setSearchFriend('');
                } else {
                    alert('Already friends!');
                }
            };

            const removeFriend = (friendId) => {
                const updatedUsers = { ...users };
                updatedUsers[currentUser].friends = updatedUsers[currentUser].friends.filter(id => id !== friendId);
                saveData(updatedUsers);
            };

            const getCardInfo = (index) => {
                let counter = 0;
                for (const [category, cards] of Object.entries(CARD_DATA)) {
                    if (index < counter + cards.length) {
                        return {
                            category,
                            name: cards[index - counter],
                            fullName: `${cards[index - counter]}`
                        };
                    }
                    counter += cards.length;
                }
                return { category: 'Unknown', name: 'Unknown', fullName: 'Unknown' };
            };

            const getCategoryIndices = (categoryName) => {
                let startIndex = 0;
                for (const [category, cards] of Object.entries(CARD_DATA)) {
                    if (category === categoryName) {
                        return Array.from({ length: cards.length }, (_, i) => startIndex + i);
                    }
                    startIndex += cards.length;
                }
                return [];
            };

            const findTradingOpportunities = () => {
                if (!currentUser) return [];
                const myCards = users[currentUser].cards;
                const opportunities = [];

                users[currentUser].friends.forEach(friendId => {
                    const friend = users[friendId];
                    const myNeeds = [];
                    const theyNeed = [];

                    myCards.forEach((count, index) => {
                        if (count === 0 && friend.cards[index] > 1) {
                            myNeeds.push(index);
                        }
                        if (count > 1 && friend.cards[index] === 0) {
                            theyNeed.push(index);
                        }
                    });

                    if (myNeeds.length > 0 || theyNeed.length > 0) {
                        opportunities.push({ friend, myNeeds, theyNeed });
                    }
                });

                return opportunities;
            };

            if (showLogin) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full">
                            <h1 className="text-3xl font-bold text-center mb-6 text-gray-800">Township Card Tracker</h1>
                            <div className="space-y-4">
                                <div>
                                    <h2 className="text-xl font-semibold mb-3">Create New Account</h2>
                                    <input
                                        id="createUsername"
                                        type="text"
                                        placeholder="Enter your username"
                                        className="w-full p-3 border border-gray-300 rounded-lg mb-2"
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter' && e.target.value.trim()) {
                                                createUser(e.target.value.trim());
                                            }
                                        }}
                                    />
                                    <button
                                        onClick={() => {
                                            const input = document.getElementById('createUsername');
                                            if (input.value.trim()) createUser(input.value.trim());
                                        }}
                                        className="w-full bg-green-500 text-white p-3 rounded-lg font-semibold hover:bg-green-600"
                                    >
                                        Create Account
                                    </button>
                                </div>
                                <div className="border-t pt-4">
                                    <h2 className="text-xl font-semibold mb-3">Login</h2>
                                    <input
                                        id="loginUserId"
                                        type="text"
                                        placeholder="Enter your User ID"
                                        className="w-full p-3 border border-gray-300 rounded-lg mb-2"
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter' && e.target.value.trim()) {
                                                loginUser(e.target.value.trim());
                                            }
                                        }}
                                    />
                                    <button
                                        onClick={() => {
                                            const input = document.getElementById('loginUserId');
                                            if (input.value.trim()) loginUser(input.value.trim());
                                        }}
                                        className="w-full bg-blue-500 text-white p-3 rounded-lg font-semibold hover:bg-blue-600"
                                    >
                                        Login
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            const user = users[currentUser];
            const myCollection = user.cards.filter(c => c > 0).length;
            const myDuplicates = user.cards.filter(c => c > 1).length;
            const opportunities = findTradingOpportunities();

            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 shadow-lg">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div>
                                <h1 className="text-2xl font-bold">Township Card Tracker</h1>
                                <p className="text-sm opacity-90">Welcome, {user.username}!</p>
                            </div>
                            <div className="text-right">
                                <p className="text-sm">Your ID: <span className="font-mono font-bold">{currentUser}</span></p>
                                <button
                                    onClick={() => {
                                        setShowLogin(true);
                                        setCurrentUser(null);
                                    }}
                                    className="text-xs bg-white bg-opacity-20 px-3 py-1 rounded mt-1 hover:bg-opacity-30"
                                >
                                    Logout
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="max-w-7xl mx-auto p-4">
                        <div className="grid grid-cols-3 gap-4 mb-6">
                            <div className="bg-white p-4 rounded-lg shadow">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-gray-600 text-sm">Collection</p>
                                        <p className="text-3xl font-bold text-blue-600">{myCollection}/{TOTAL_CARDS}</p>
                                    </div>
                                    <span className="text-4xl">üì¶</span>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-gray-600 text-sm">Duplicates</p>
                                        <p className="text-3xl font-bold text-green-600">{myDuplicates}</p>
                                    </div>
                                    <span className="text-4xl">üîÑ</span>
                                </div>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-gray-600 text-sm">Friends</p>
                                        <p className="text-3xl font-bold text-purple-600">{user.friends.length}</p>
                                    </div>
                                    <span className="text-4xl">üë•</span>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow mb-6">
                            <div className="flex border-b">
                                <button
                                    onClick={() => setActiveTab('my-cards')}
                                    className={`flex-1 p-4 font-semibold ${activeTab === 'my-cards' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
                                >
                                    My Cards
                                </button>
                                <button
                                    onClick={() => setActiveTab('friends')}
                                    className={`flex-1 p-4 font-semibold ${activeTab === 'friends' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
                                >
                                    Friends
                                </button>
                                <button
                                    onClick={() => setActiveTab('trading')}
                                    className={`flex-1 p-4 font-semibold ${activeTab === 'trading' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
                                >
                                    Trading ({opportunities.length})
                                </button>
                            </div>

                            <div className="p-4">
                                {activeTab === 'my-cards' && (
                                    <div>
                                        <div className="mb-4">
                                            <select
                                                value={selectedCategory}
                                                onChange={(e) => setSelectedCategory(e.target.value)}
                                                className="w-full p-2 border border-gray-300 rounded-lg"
                                            >
                                                <option value="all">All Categories ({TOTAL_CARDS} cards)</option>
                                                {CATEGORIES.map(cat => (
                                                    <option key={cat} value={cat}>{cat} ({CARD_DATA[cat].length} cards)</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                                            {(selectedCategory === 'all' 
                                                ? Array.from({ length: TOTAL_CARDS }, (_, i) => i) 
                                                : getCategoryIndices(selectedCategory)
                                            ).map(index => {
                                                const cardInfo = getCardInfo(index);
                                                return (
                                                    <div key={index} className={`p-3 rounded-lg border-2 ${user.cards[index] === 0 ? 'border-red-200 bg-red-50' : user.cards[index] === 1 ? 'border-blue-200 bg-blue-50' : 'border-green-200 bg-green-50'}`}>
                                                        <p className="text-xs font-semibold text-gray-500 mb-1">{cardInfo.category}</p>
                                                        <p className="text-sm font-bold text-gray-800 mb-2">{cardInfo.name}</p>
                                                        <div className="flex items-center gap-2">
                                                            <button
                                                                onClick={() => updateCard(index, user.cards[index] - 1)}
                                                                className="w-8 h-8 bg-gray-200 rounded hover:bg-gray-300 font-bold"
                                                            >
                                                                -
                                                            </button>
                                                            <span className="flex-1 text-center font-bold">{user.cards[index]}</span>
                                                            <button
                                                                onClick={() => updateCard(index, user.cards[index] + 1)}
                                                                className="w-8 h-8 bg-gray-200 rounded hover:bg-gray-300 font-bold"
                                                            >
                                                                +
                                                            </button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'friends' && (
                                    <div>
                                        <div className="mb-4 flex gap-2">
                                            <input
                                                type="text"
                                                placeholder="Enter Friend ID"
                                                value={searchFriend}
                                                onChange={(e) => setSearchFriend(e.target.value)}
                                                className="flex-1 p-3 border border-gray-300 rounded-lg"
                                            />
                                            <button
                                                onClick={() => addFriend(searchFriend)}
                                                className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700"
                                            >
                                                ‚ûï Add
                                            </button>
                                        </div>
                                        <div className="space-y-3">
                                            {user.friends.map(friendId => {
                                                const friend = users[friendId];
                                                if (!friend) return null;
                                                return (
                                                    <div key={friendId} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                                        <div>
                                                            <p className="font-semibold">{friend.username}</p>
                                                            <p className="text-sm text-gray-600 font-mono">{friendId}</p>
                                                            <p className="text-sm text-gray-600">Collection: {friend.cards.filter(c => c > 0).length}/{TOTAL_CARDS}</p>
                                                        </div>
                                                        <button
                                                            onClick={() => removeFriend(friendId)}
                                                            className="text-red-600 hover:bg-red-100 p-2 rounded"
                                                        >
                                                            üóëÔ∏è
                                                        </button>
                                                    </div>
                                                );
                                            })}
                                            {user.friends.length === 0 && (
                                                <p className="text-center text-gray-500 py-8">No friends yet. Add friends to start trading!</p>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'trading' && (
                                    <div className="space-y-4">
                                        {opportunities.map(({ friend, myNeeds, theyNeed }) => (
                                            <div key={friend.id} className="border border-gray-200 rounded-lg p-4">
                                                <h3 className="font-bold text-lg mb-3">{friend.username}</h3>
                                                {myNeeds.length > 0 && (
                                                    <div className="mb-3">
                                                        <p className="font-semibold text-green-700 mb-2">They can send you ({myNeeds.length}):</p>
                                                        <div className="flex flex-wrap gap-2">
                                                            {myNeeds.slice(0, 10).map(index => {
                                                                const cardInfo = getCardInfo(index);
                                                                return (
                                                                    <span key={index} className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">
                                                                        {cardInfo.name}
                                                                    </span>
                                                                );
                                                            })}
                                                            {myNeeds.length > 10 && <span className="text-xs text-gray-500">+{myNeeds.length - 10} more</span>}
                                                        </div>
                                                    </div>
                                                )}
                                                {theyNeed.length > 0 && (
                                                    <div>
                                                        <p className="font-semibold text-blue-700 mb-2">You can send them ({theyNeed.length}):</p>
                                                        <div className="flex flex-wrap gap-2">
                                                            {theyNeed.slice(0, 10).map(index => {
                                                                const cardInfo = getCardInfo(index);
                                                                return (
                                                                    <span key={index} className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                                                        {cardInfo.name}
                                                                    </span>
                                                                );
                                                            })}
                                                            {theyNeed.length > 10 && <span className="text-xs text-gray-500">+{theyNeed.length - 10} more</span>}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                        {opportunities.length === 0 && (
                                            <p className="text-center text-gray-500 py-8">No trading opportunities yet. Add more friends or update your cards!</p>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
